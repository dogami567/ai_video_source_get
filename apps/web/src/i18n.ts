export type Locale = "en" | "zh-CN";

const STORAGE_KEY = "vidunpack_locale";

export type I18nVars = Record<string, string | number | boolean | null | undefined>;

const en = {
  appTitle: "VidUnpack",
  appSubtitle: "Video Decomposition Workspace",

  langEN: "EN",
  langZH: "中文",
  langToggleTitle: "Switch language",

  systemError: "System Error",
  orchestrator: "Orchestrator",
  toolserver: "Toolserver",

  projects: "Projects",
  refresh: "Refresh",
  newProjectTitlePlaceholder: "New project title",
  creating: "Creating…",
  createProject: "Create Project",
  loadingProjects: "Loading projects…",
  emptyProjects: "No projects found. Create one to get started.",
  quickStartTitle: "Quick start",
  quickStartStep1: "Open Settings and set API keys (optional).",
  quickStartStep2: "Create a project.",
  quickStartStep3: "Import a local video or paste a URL (consent required).",
  quickStartStep4: "Run analysis/search, then export a zip.",
  openSettings: "Open Settings",
  title: "Title",
  created: "Created",
  action: "Action",
  open: "Open",
  delete: "Delete",
  deleteSelected: "Delete Selected ({count})",
  confirmDeleteProject: "Delete project \"{title}\"? This cannot be undone.",
  confirmDeleteSelected: "Delete {count} selected projects? This cannot be undone.",
  untitled: "Untitled",

  backToProjects: "Projects",
  idLabel: "ID",
  loadingProjectData: "Loading project data…",

  colConfig: "Configuration",
  colWorkspace: "Workspace",
  colResults: "Results",

  chat: "Chat",
  newChat: "New chat",
  loadingChats: "Loading chats…",
  noChats: "No chats yet.",
  loadingMessages: "Loading messages…",
  chatEmptyMessages: "Start a conversation to get video cards.",
  upload: "Upload",
  send: "Send",
  sending: "Sending…",
  chatPlaceholder: "Describe your idea… (Enter to send, Shift+Enter for newline)",
  chatHint: "Enter to send • Shift+Enter for newline",
  chatProgressLine: "Running: {text}",
  chatProgressDetails: "Details",
  stageConnected: "Connected",
  stageStarting: "Starting",
  stagePlanning: "Planning",
  stageResolve: "Resolving",
  stageSearch: "Searching",
  stageSearchQuery: "Search query",
  stageReview: "Reviewing",
  stageRefine: "Refining",
  stageSaving: "Saving",
  stageDone: "Done",
  stageMock: "Mock",
  stageAnalysis: "Analyzing",
  stageDownload: "Downloading",

  settings: "Settings",
  globalSettingsTitle: "Global Settings",
  globalSettingsHint:
    "Saved locally in this browser. Leave fields empty to fall back to .env. Tip: for OpenAI-compatible relays, set Base URL to your relay (with or without /v1) and put the relay key in API Key.",
  settingsGemini: "Gemini",
  settingsBaseUrl: "Base URL",
  settingsGeminiKey: "API Key",
  settingsDefaultModel: "Default Model",
  settingsExa: "Exa",
  settingsExaKey: "Exa API Key",
  settingsExaHint: "Used for search and fetch tools.",
  settingsGoogle: "Google",
  settingsGoogleKey: "Google CSE API Key",
  settingsGoogleCx: "Google CSE CX",
  settingsGoogleHint: "Optional. If set, Chat will prefer Google Custom Search for web search.",
  settingsDownloader: "Downloader",
  settingsCookiesFromBrowser: "Cookies from browser",
  settingsCookiesFromBrowserHint:
    "Optional. If you are logged in in your browser, set e.g. 'chrome' or 'edge' to let yt-dlp reuse it. (This does not store cookies here.)",
  openBilibiliLogin: "Open Bilibili login",
  detectedBrowsers: "Detected browsers",
  cookiesLoginWhat:
    "Login is for the target site (e.g. Bilibili) in the same browser profile you selected above (not incognito). This is not for Google/Gemini.",
  settingsKeyPlaceholder: "Paste your API key",
  settingsEmptyUsesEnv: "Leave blank to use .env",
  clear: "Clear",
  saved: "Saved",
  autoConfirmDownloads: "Auto-confirm downloads",
  consent: "Consent",
  granted: "Granted",
  pending: "Pending",
  enableReasoning: "Enable Reasoning",
  latestPlan: "Latest Plan",
  toolDeps: "Tool dependencies",
  toolDepsHint: "Resolve uses yt-dlp. Downloads often require ffmpeg/ffprobe. Restart after installing.",
  toolDepOk: "ok",
  toolDepMissing: "missing",

  backendOfflineTitle: "Backend is offline",
  backendOfflineDesc: "Start the local dev servers before using this app.",
  backendOfflineCommand: "Command:",

  inputs: "Inputs",
  localVideo: "Local Video",
  import: "Import",
  videoUrl: "Video URL",
  save: "Save",
  resolve: "Resolve",
  downloadNow: "Download",
  resolvedOk: "Resolved",
  openDownloadedVideo: "Open video",
  openInfoJson: "Info JSON",
  videosCount: "Videos ({count})",
  urlsCount: "URLs ({count})",

  analysis: "Analysis",
  modelIdPlaceholder: "Model ID",
  noVideoAvailable: "No video available",
  analyzing: "Analyzing…",
  runAnalysis: "Run Analysis",
  analysisPlaceholder: "Analysis results will appear here.",

  contextSearch: "Context Search",
  usageStats: "Exa: {exa}/3 • Fetch: {fetch}/3",
  searchQueryPlaceholder: "Search query...",
  searching: "Searching…",
  search: "Search",
  fetch: "Fetch",
  add: "Add",
  fetched: "Fetched: {url}",

  assetPool: "Asset Pool",
  selected: "Selected: {count}",
  noItemsInPool: "No items in pool.",
  asset: "Asset",
  source: "Source",
  select: "Select",

  export: "Export",
  exportReportBundle: "Report + Manifest",
  exportReportBundleDesc: "Include report.html + manifest.json (auto-generated on export if missing).",
  includeOriginalVideo: "Include original video in Zip",
  exportOriginalVideoDesc: "The imported input video file.",
  exportClips: "Clips (start / mid / end)",
  exportClipsDesc: "Requires ffmpeg pipeline (run Analyze once).",
  exportAudio: "Audio (WAV)",
  exportAudioDesc: "Requires ffmpeg pipeline (run Analyze once).",
  exportThumbnails: "Thumbnails",
  exportThumbnailsDesc: "Requires ffmpeg pipeline (run Analyze once).",
  exportAlwaysIncluded: "Always included: selected_pool.json",
  generatingReport: "Generating Report…",
  genReport: "Gen Report",
  estimating: "Estimating…",
  estimateSize: "Estimate Size",
  exporting: "Exporting…",
  exportZip: "Export Zip",
  reportManifestGenerated: "✓ Report & Manifest generated",
  estimateLabel: "Estimate:",
  zipReady: "✓ Zip Ready:",
  download: "Download",

  externalContentWarningTitle: "External Content Warning",
  externalContentWarningText:
    "You are about to save an external URL. This may trigger automated downloads or analysis.\nPlease confirm you have the right to access and process this content.",
  autoConfirmForThisProject: "Auto-confirm for this project",
  cancel: "Cancel",
  confirming: "Confirming…",
  iConfirm: "I Confirm",

  errEnterUrl: "Please enter a URL",
  errEnterMessage: "Please enter a message",
  errFfmpegRequiredForDownload: "ffmpeg is required for URL downloads. Install ffmpeg and restart toolserver.",
  errEnterModel: "Please enter a model",
  errPickLocalVideo: "Please select a local video (input_video)",
  errEnterSearchQuery: "Please enter a search query",
  noResults: "No results found.",
} satisfies Record<string, string>;

const zhCN: typeof en = {
  appTitle: "VidUnpack（视频拆解箱）",
  appSubtitle: "视频拆解工作台",

  langEN: "EN",
  langZH: "中文",
  langToggleTitle: "切换语言",

  systemError: "系统异常",
  orchestrator: "编排服务",
  toolserver: "工具服务",

  projects: "项目",
  refresh: "刷新",
  newProjectTitlePlaceholder: "新项目名称",
  creating: "创建中…",
  createProject: "创建项目",
  loadingProjects: "加载项目…",
  emptyProjects: "暂无项目，创建一个开始吧。",
  quickStartTitle: "快速开始",
  quickStartStep1: "打开「设置」并填写 API Key（可选）。",
  quickStartStep2: "创建一个项目。",
  quickStartStep3: "导入本地视频或粘贴链接（需要确认授权）。",
  quickStartStep4: "运行分析/搜索，然后导出 Zip。",
  openSettings: "打开设置",
  title: "标题",
  created: "创建时间",
  action: "操作",
  open: "打开",
  delete: "删除",
  deleteSelected: "批量删除（{count}）",
  confirmDeleteProject: "确定删除项目「{title}」吗？此操作不可撤销。",
  confirmDeleteSelected: "确定删除已选的 {count} 个项目吗？此操作不可撤销。",
  untitled: "未命名",

  backToProjects: "项目",
  idLabel: "ID",
  loadingProjectData: "加载项目数据…",

  colConfig: "配置",
  colWorkspace: "工作台",
  colResults: "结果",

  chat: "聊天",
  newChat: "新对话",
  loadingChats: "加载对话…",
  noChats: "暂无对话。",
  loadingMessages: "加载消息…",
  chatEmptyMessages: "开始聊天吧：我会帮你搜索并输出视频卡片。",
  upload: "上传",
  send: "发送",
  sending: "发送中…",
  chatPlaceholder: "说说你的想法…（Enter 发送，Shift+Enter 换行）",
  chatHint: "Enter 发送 • Shift+Enter 换行",
  chatProgressLine: "正在运行：{text}",
  chatProgressDetails: "详情",
  stageConnected: "已连接",
  stageStarting: "开始处理",
  stagePlanning: "规划中",
  stageResolve: "解析中",
  stageSearch: "搜索中",
  stageSearchQuery: "搜索查询",
  stageReview: "复盘中",
  stageRefine: "优化中",
  stageSaving: "保存中",
  stageDone: "完成",
  stageMock: "Mock（测试）",
  stageAnalysis: "分析中",
  stageDownload: "下载中",

  settings: "设置",
  globalSettingsTitle: "全局设置",
  globalSettingsHint:
    "保存到本浏览器本地。留空则回退到 .env。提示：如果你用「中转/OpenAI 兼容」，Base URL 填中转地址（可带 /v1），API Key 填中转 key。",
  settingsGemini: "Gemini",
  settingsBaseUrl: "Base URL",
  settingsGeminiKey: "API Key（Gemini/中转）",
  settingsDefaultModel: "默认模型",
  settingsExa: "Exa",
  settingsExaKey: "Exa API Key",
  settingsExaHint: "用于联网搜索与抓取。",
  settingsGoogle: "Google 搜索",
  settingsGoogleKey: "Google CSE API Key",
  settingsGoogleCx: "Google CSE CX",
  settingsGoogleHint: "可选：填写后，Chat 会优先用 Google 自定义搜索做联网搜索（否则继续用 Exa）。",
  settingsDownloader: "下载/解析",
  settingsCookiesFromBrowser: "从浏览器读取登录态",
  settingsCookiesFromBrowserHint:
    "可选：先在浏览器完成登录，再填 chrome/edge/firefox 让 yt-dlp 复用登录态（这里只保存浏览器名，不保存 cookie）。",
  openBilibiliLogin: "打开 B 站登录页",
  detectedBrowsers: "检测到的浏览器",
  cookiesLoginWhat: "这里登录的是目标站点（例如 B 站），并且要在你上面选的浏览器“正常模式/默认档案”里登录（别用无痕）。这和 Google/Gemini 没关系。",
  toolDeps: "工具依赖",
  toolDepsHint: "解析依赖 yt-dlp；下载通常需要 ffmpeg/ffprobe。安装后请重启后端。",
  toolDepOk: "可用",
  toolDepMissing: "缺失",
  settingsKeyPlaceholder: "粘贴你的 API Key",
  settingsEmptyUsesEnv: "留空则使用 .env",
  clear: "清除",
  saved: "已保存",
  autoConfirmDownloads: "自动确认下载",
  consent: "授权",
  granted: "已授权",
  pending: "待确认",
  enableReasoning: "启用思考",
  latestPlan: "最新计划",

  backendOfflineTitle: "后端未启动",
  backendOfflineDesc: "请先启动本地服务后再使用本应用。",
  backendOfflineCommand: "命令：",

  inputs: "输入",
  localVideo: "本地视频",
  import: "导入",
  videoUrl: "视频链接",
  save: "保存",
  resolve: "解析",
  downloadNow: "下载",
  resolvedOk: "已解析",
  openDownloadedVideo: "打开视频",
  openInfoJson: "元信息 JSON",
  videosCount: "视频（{count}）",
  urlsCount: "链接（{count}）",

  analysis: "分析",
  modelIdPlaceholder: "模型 ID",
  noVideoAvailable: "没有可用视频",
  analyzing: "分析中…",
  runAnalysis: "运行分析",
  analysisPlaceholder: "分析结果会显示在这里。",

  contextSearch: "联网搜索",
  usageStats: "Exa：{exa}/3 • 抓取：{fetch}/3",
  searchQueryPlaceholder: "搜索关键词…",
  searching: "搜索中…",
  search: "搜索",
  fetch: "抓取",
  add: "加入",
  fetched: "已抓取：{url}",

  assetPool: "素材池",
  selected: "已选：{count}",
  noItemsInPool: "素材池为空。",
  asset: "素材",
  source: "来源",
  select: "选择",

  export: "导出",
  exportReportBundle: "报告 + 清单",
  exportReportBundleDesc: "包含 report.html + manifest.json（缺失时导出会自动生成）",
  includeOriginalVideo: "Zip 中包含原视频",
  exportOriginalVideoDesc: "导入的 input_video 原文件",
  exportClips: "剪辑片段（开头/中间/结尾）",
  exportClipsDesc: "需要先跑一次分析（会触发 ffmpeg）",
  exportAudio: "音频（WAV）",
  exportAudioDesc: "需要先跑一次分析（会触发 ffmpeg）",
  exportThumbnails: "缩略图",
  exportThumbnailsDesc: "需要先跑一次分析（会触发 ffmpeg）",
  exportAlwaysIncluded: "始终包含：selected_pool.json（已选素材快照）",
  generatingReport: "生成报告中…",
  genReport: "生成报告",
  estimating: "估算中…",
  estimateSize: "估算大小",
  exporting: "打包中…",
  exportZip: "导出 Zip",
  reportManifestGenerated: "✓ 已生成报告与清单",
  estimateLabel: "预计：",
  zipReady: "✓ Zip 就绪：",
  download: "下载",

  externalContentWarningTitle: "外部内容提示",
  externalContentWarningText:
    "你将要保存一个外部链接，这可能触发自动下载或分析。\n请确认你有权访问并处理该内容。",
  autoConfirmForThisProject: "本项目自动确认",
  cancel: "取消",
  confirming: "确认中…",
  iConfirm: "我确认",

  errEnterUrl: "请输入 URL",
  errEnterMessage: "请输入内容",
  errFfmpegRequiredForDownload: "下载链接需要 ffmpeg（用于合并音视频为 mp4）。请安装 ffmpeg 并重启后端。",
  errEnterModel: "请输入 model",
  errPickLocalVideo: "请选择一个本地视频（input_video）",
  errEnterSearchQuery: "请输入 search query",
  noResults: "未找到结果。",
};

export const messages = { en, "zh-CN": zhCN } as const;
export type MessageKey = keyof typeof en;

export function getInitialLocale(): Locale {
  try {
    const saved = String(localStorage.getItem(STORAGE_KEY) || "").trim();
    if (saved === "en" || saved === "zh-CN") return saved;
  } catch {
    // ignore
  }

  const nav = typeof navigator !== "undefined" ? String(navigator.language || "").toLowerCase() : "";
  if (nav.startsWith("zh")) return "zh-CN";
  return "en";
}

export function persistLocale(locale: Locale) {
  try {
    localStorage.setItem(STORAGE_KEY, locale);
  } catch {
    // ignore
  }
}

export function t(locale: Locale, key: MessageKey, vars?: I18nVars): string {
  const template = messages[locale]?.[key] ?? messages.en[key] ?? String(key);
  if (!vars) return template;
  return template.replace(/\{(\w+)\}/g, (_m, k: string) => String(vars[k] ?? `{${k}}`));
}
